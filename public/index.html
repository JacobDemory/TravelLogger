<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveler's Log</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Traveler's Log</h1>
            <p>Check the weather and log your journey.</p>
        </header>

        <div class="search-box">
            <input type="text" id="cityInput" placeholder="Enter City (e.g. London)">
            <button onclick="searchCity()">Get Weather</button>
        </div>

        <div id="result" class="card hidden">
            <h2 id="resCity">City Name</h2>
            <div class="weather-info">
                <h3 id="resTemp">25°C</h3>
                <p id="resDesc">Clear Sky</p>
            </div>
            
            <div class="log-form">
                <textarea id="logNotes" placeholder="Write a memory about this place..."></textarea>
                <button id="saveBtn" onclick="saveTrip()">Log This Trip</button>
            </div>
            <p id="msg" class="success-msg"></p>
        </div>

        <hr>

        <h2>My Travel History</h2>
        <button class="refresh-btn" onclick="loadLogs()">Refresh History</button>
        <div id="logsGrid" class="grid"></div>
    </div>

    <script>
        let currentData = null;

        // Open-Meteo returns codes. We map them to text manually.
        function getWeatherDescription(code) {
            const codes = {
                0: 'Clear Sky', 1: 'Mainly Clear', 2: 'Partly Cloudy', 3: 'Overcast',
                45: 'Fog', 48: 'Depositing Rime Fog', 51: 'Light Drizzle', 61: 'Rain',
                71: 'Snow', 95: 'Thunderstorm'
            };
            return codes[code] || 'Varied Weather';
        }

        async function searchCity() {
            const city = document.getElementById('cityInput').value;
            if(!city) return alert("Please enter a city");

            const res = await fetch(`/api/weather/${city}`);
            const data = await res.json();

            if (data.error) {
                alert('City not found!');
                return;
            }

            // Save data to global var so we can use it in saveTrip()
            currentData = data;
            
            // Update UI
            document.getElementById('resCity').innerText = `${data.name}, ${data.country}`;
            document.getElementById('resTemp').innerText = `${data.temperature}°C`;
            document.getElementById('resDesc').innerText = getWeatherDescription(data.weathercode);
            
            document.getElementById('result').classList.remove('hidden');
            document.getElementById('msg').innerText = '';
        }

        async function saveTrip() {
            if (!currentData) return;
            const notes = document.getElementById('logNotes').value;
            
            const payload = {
                city: currentData.name,
                country: currentData.country,
                temperature: currentData.temperature,
                condition: getWeatherDescription(currentData.weathercode),
                notes: notes
            };

            const res = await fetch('/api/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const responseData = await res.json();
            document.getElementById('msg').innerText = responseData.message;
            document.getElementById('logNotes').value = ''; // Clear text area
            loadLogs(); // Refresh list
        }

        async function loadLogs() {
            const res = await fetch('/api/logs');
            const data = await res.json();
            const grid = document.getElementById('logsGrid');
            grid.innerHTML = '';

            data.forEach(trip => {
                const div = document.createElement('div');
                div.className = 'log-card';
                div.innerHTML = `
                    <div class="log-header">
                        <strong>${trip.city}, ${trip.country}</strong>
                        <span>${trip.temperature}°C</span>
                    </div>
                    <small>${trip.condition}</small>
                    <p class="notes">"${trip.notes}"</p>
                    <button class="del-btn" onclick="deleteLog('${trip._id}')">Delete</button>
                `;
                grid.appendChild(div);
            });
        }

        async function deleteLog(id) {
            await fetch('/api/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            loadLogs();
        }

        // Load on start
        loadLogs();
    </script>
</body>
</html>