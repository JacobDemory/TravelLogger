<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveler's Log</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet"> <!-- Google Font Requirement -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Traveler's Log</h1>
            <p>Check the weather and log your journey.</p>
            <button onclick="toggleUnits()" id="unitBtn">Switch to °F</button>
        </header>

        <form onsubmit="searchCity(event)" class="search-box">
            <input type="text" id="cityInput" placeholder="Enter City (e.g. London)" required>
            <button type="submit">Get Weather</button>
        </form>

        <div id="result" class="card hidden">
            <h2 id="resCity">City Name</h2>
            <div class="weather-info">
                <h3 id="resTemp">25°C</h3>
                <p id="resDesc">Clear Sky</p>
            </div>
            
            <div class="log-form">
                <input type="hidden" id="editId">
                <textarea id="logNotes" placeholder="Write a memory about this place..."></textarea>
                <div class="btn-group">
                    <button id="saveBtn" onclick="saveTrip()">Log This Trip</button>
                    <button id="cancelBtn" class="hidden cancel-btn" onclick="cancelEdit()">Cancel Edit</button>
                </div>
            </div>
            <p id="msg" class="success-msg"></p>
        </div>

        <hr>

        <div class="history-header">
            <h2>My Travel History</h2>
            <button class="clear-all-btn" onclick="clearAllLogs()">Clear History</button>
        </div>
        
        <form onsubmit="searchLogs(event)" class="search-box">
            <input type="text" id="dbSearchInput" placeholder="Search your logs...">
            <button type="submit">Search Logs</button>
        </form>
        
        <button class="refresh-btn" onclick="loadLogs()">Show All</button>
        <div id="logsGrid" class="grid"></div>
    </div>

    <script>
        let currentData = null;
        let isCelsius = true;

        function getWeatherDescription(code) {
            const codes = {
                0: 'Clear Sky', 1: 'Mainly Clear', 2: 'Partly Cloudy', 3: 'Overcast',
                45: 'Fog', 48: 'Depositing Rime Fog', 51: 'Light Drizzle', 61: 'Rain',
                71: 'Snow', 95: 'Thunderstorm'
            };
            return codes[code] || 'Varied Weather';
        }

        function toggleUnits() {
            isCelsius = !isCelsius;
            document.getElementById('unitBtn').innerText = isCelsius ? "Switch to °F" : "Switch to °C";
            
            // Update displayed search result if it exists
            if (currentData) {
                updateDisplayTemp();
            }
            // Reload logs to update their units too
            loadLogs();
        }

        function formatTemp(celsius) {
            if (isCelsius) return `${celsius}°C`;
            const f = (celsius * 9/5) + 32;
            return `${f.toFixed(1)}°F`;
        }

        async function searchCity(event) {
            event.preventDefault(); 
            const city = document.getElementById('cityInput').value;
            
            const res = await fetch(`/api/weather/${city}`);
            const data = await res.json();

            if (data.error) {
                alert('City not found!');
                return;
            }

            cancelEdit();
            currentData = data;

            // Check if state exists. If so, format as "City, State, Country"
            const locationString = data.state ? `${data.name}, ${data.state}, ${data.country}` : `${data.name}, ${data.country}`;
            
            document.getElementById('resCity').innerText = locationString;
            document.getElementById('resDesc').innerText = getWeatherDescription(data.weathercode);
            updateDisplayTemp();
            
            document.getElementById('result').classList.remove('hidden');
            document.getElementById('msg').innerText = '';
        }

        function updateDisplayTemp() {
            if(currentData) {
                document.getElementById('resTemp').innerText = formatTemp(currentData.temperature);
            }
        }

        async function saveTrip() {
            const notes = document.getElementById('logNotes').value;
            const editId = document.getElementById('editId').value;
            const msg = document.getElementById('msg');

            if (editId) {
                await fetch('/api/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: editId, notes: notes })
                });
                msg.innerText = "Trip updated successfully!";
                cancelEdit(); 
            } else {
                if (!currentData) return;
                // Always save to DB in Celsius for consistency
                const payload = {
                    city: currentData.name,
                    state: currentData.state,
                    country: currentData.country,
                    temperature: currentData.temperature, 
                    condition: getWeatherDescription(currentData.weathercode),
                    notes: notes
                };

                const res = await fetch('/api/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                msg.innerText = data.message;
                document.getElementById('logNotes').value = ''; 
            }
            loadLogs(); 
        }

        async function searchLogs(event) {
            event.preventDefault();
            const query = document.getElementById('dbSearchInput').value;
            const res = await fetch(`/api/logs/search?q=${query}`);
            const data = await res.json();
            renderLogs(data);
        }

        async function loadLogs() {
            const res = await fetch('/api/logs');
            const data = await res.json();
            renderLogs(data);
        }

        async function clearAllLogs() {
            if(!confirm("Are you sure you want to delete your ENTIRE travel history? This cannot be undone.")) return;
            
            await fetch('/api/clear', { method: 'POST' });
            loadLogs();
        }

        function renderLogs(data) {
            const grid = document.getElementById('logsGrid');
            grid.innerHTML = '';

            if(data.length === 0) {
                grid.innerHTML = '<p>No trips logged yet.</p>';
                return;
            }

            data.forEach(trip => {
                const div = document.createElement('div');
                div.className = 'log-card';
                const safeNotes = trip.notes.replace(/'/g, "\\'"); 
                const safeCity = trip.city.replace(/'/g, "\\'");
                const safeState = trip.state ? trip.state.replace(/'/g, "\\'") : '';

                // Format the display string
                const displayLocation = trip.state ? `${trip.city}, ${trip.state}, ${trip.country}` : `${trip.city}, ${trip.country}`;

                div.innerHTML = `
                    <div class="log-header">
                        <strong>${displayLocation}</strong>
                        <span>${formatTemp(trip.temperature)}</span>
                    </div>
                    <small>${trip.condition}</small>
                    <p class="notes">"${trip.notes}"</p>
                    <div class="card-actions">
                        <button class="edit-btn" onclick="startEdit('${trip._id}', '${displayLocation}', '${safeNotes}')">Edit</button>
                        <button class="del-btn" onclick="deleteLog('${trip._id}')">Delete</button>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function startEdit(id, city, notes) {
            window.scrollTo(0, 0);
            document.getElementById('result').classList.remove('hidden');
            
            document.getElementById('resCity').innerText = `Editing: ${city}`;
            document.getElementById('resTemp').innerText = ''; 
            document.getElementById('logNotes').value = notes;
            document.getElementById('editId').value = id;

            document.getElementById('saveBtn').innerText = "Update Trip";
            document.getElementById('saveBtn').style.backgroundColor = "#ffa726"; 
            document.getElementById('cancelBtn').classList.remove('hidden');
            document.getElementById('msg').innerText = "Edit Mode Active";
        }

        function cancelEdit() {
            document.getElementById('editId').value = '';
            document.getElementById('logNotes').value = '';
            document.getElementById('saveBtn').innerText = "Log This Trip";
            document.getElementById('saveBtn').style.backgroundColor = "#00bcd4"; 
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('msg').innerText = "";
            
            if(!currentData) {
                document.getElementById('result').classList.add('hidden');
            } else {
                document.getElementById('resCity').innerText = `${currentData.name}, ${currentData.country}`;
                updateDisplayTemp();
            }
        }

        async function deleteLog(id) {
            if(!confirm("Delete this trip?")) return;
            await fetch('/api/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            loadLogs();
        }

        loadLogs();
    </script>
</body>
</html>